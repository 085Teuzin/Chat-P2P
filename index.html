<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Chat P2P - Made By: @085_Teuzinnn</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --orange: #f97316; --dark: #09090b; --card: #18181b; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background-color: #000; 
            color: #fff; 
            font-family: system-ui, -apple-system, sans-serif; 
            height: 100dvh; 
            margin: 0; 
            display: flex; 
            justify-content: center; 
            overflow: hidden; 
        }
        
        #app-container { 
            width: 100%; 
            max-width: 450px; 
            background-color: var(--dark); 
            height: 100dvh; /* Altura dinÃ¢mica para mobile */
            position: relative; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        
        #lobby { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            padding: 24px; 
            text-align: center; 
        }

        #chat-screen { 
            display: none; 
            flex-direction: column; 
            height: 100dvh; 
        }
        
        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px); 
            background-size: 20px 20px; 
        }
        
        .msg { 
            max-width: 80%; 
            padding: 10px 14px; 
            border-radius: 18px; 
            font-size: 15px; 
            line-height: 1.4; 
        }
        .msg-me { align-self: flex-end; background: var(--orange); color: white; border-bottom-right-radius: 2px; }
        .msg-them { align-self: flex-start; background: var(--card); border: 1px solid #27272a; border-bottom-left-radius: 2px; }
        
        .input-area { 
            background: #121214; 
            padding: 12px 12px calc(12px + env(safe-area-inset-bottom)); /* EspaÃ§amento para o rodapÃ© do celular */
            border-top: 1px solid #27272a; 
        }
        
        #call-overlay { 
            position: absolute; 
            inset: 0; 
            background: rgba(9,9,11,0.98); 
            z-index: 100; 
            display: none; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }

        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; display: inline-block; margin-right: 5px; }
        #messages::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body>

<div id="app-container">
    <div id="lobby">
        <h1 class="text-4xl font-black text-orange-500 mb-2">Chat P2P</h1>
        <h2 class="text-zinc-500 text-sm mb-10 font-medium">Dica: Use o mesmo nome de sala</h2>
        
        <div class="space-y-4">
            <input type="text" id="userName" placeholder="Seu Nome" class="w-full p-4 rounded-2xl bg-zinc-900 border border-zinc-800 outline-none focus:border-orange-500 transition-all">
            <input type="text" id="roomName" placeholder="Nome da Sala" class="w-full p-4 rounded-2xl bg-zinc-900 border border-zinc-800 outline-none focus:border-orange-500 transition-all">
            
            <div class="flex gap-3 pt-4">
                <button onclick="initPeer(true)" class="flex-1 bg-orange-500 p-4 rounded-2xl font-bold active:scale-95 transition-transform">Criar</button>
                <button onclick="initPeer(false)" class="flex-1 border border-orange-500 text-orange-500 p-4 rounded-2xl font-bold active:scale-95 transition-transform">Entrar</button>
            </div>
        </div>

        <footer class="text-center mt-12 text-gray-500 text-xs">
            Made By: <a href="https://instagram.com/085_Teuzinnn" target="_blank" class="text-blue-400 hover:text-blue-300 font-semibold transition duration-200">@085_Teuzinnn</a>
        </footer>
    </div>

    <div id="chat-screen">
        <header class="p-4 bg-zinc-900/50 backdrop-blur-md border-b border-zinc-800 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center font-bold" id="avatar">?</div>
                <div>
                    <p id="peer-name" class="font-bold text-sm">Desconectado</p>
                    <p class="text-[10px] text-zinc-400"><span class="status-dot"></span>Online</p>
                </div>
            </div>
            <div class="flex gap-5 items-center">
                <button onclick="startAudioCall()" class="text-xl active:scale-110 transition">ðŸ“ž</button>
                <button onclick="clearChat()" class="text-xl active:scale-110 transition">ðŸ§¹</button>
                <button onclick="exitRoom()" class="text-xl active:scale-110 transition">ðŸšª</button>
            </div>
        </header>

        <div id="messages"></div>

        <div id="typing-status" class="px-4 text-[10px] text-orange-500 h-4 italic"></div>

        <div class="input-area">
            <div class="flex items-center gap-2 bg-zinc-800 rounded-2xl p-1 px-3 border border-zinc-700">
                <label class="cursor-pointer text-xl p-1">
                    ðŸ“Ž <input type="file" id="fileInput" class="hidden" onchange="handleFile(this)">
                </label>
                <input type="text" id="msgInput" oninput="sendTyping()" placeholder="Mensagem..." class="flex-1 p-2 bg-transparent outline-none text-sm text-white">
                <button onclick="sendMessage()" class="bg-orange-500 w-9 h-9 rounded-full flex items-center justify-center active:scale-90 transition">
                    <svg viewBox="0 0 24 24" class="w-5 h-5 fill-white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="call-overlay">
        <div class="w-24 h-24 bg-orange-500 rounded-full flex items-center justify-center text-4xl mb-4 animate-bounce">ðŸ“ž</div>
        <p class="text-xl font-bold mb-8">Em ligaÃ§Ã£o...</p>
        <button onclick="endCall()" class="bg-red-600 px-12 py-4 rounded-full font-bold shadow-lg active:scale-95">Desligar</button>
        <audio id="remoteAudio" autoplay></audio>
    </div>
</div>

<script>
    let peer, conn, myName, myStream;
    const msgInput = document.getElementById('msgInput');
    const messagesDiv = document.getElementById('messages');

    function initPeer(isHost) {
        myName = document.getElementById('userName').value.trim();
        let room = document.getElementById('roomName').value.trim();
        if (!myName || !room) return alert("Preencha os campos!");

        const cleanId = "P2P_CHAT_" + room.toLowerCase().replace(/[^a-z0-9]/g, '');

        peer = isHost ? new Peer(cleanId) : new Peer();

        peer.on('open', (id) => {
            if (!isHost) {
                conn = peer.connect(cleanId);
                setupConnection();
            }
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
        });

        peer.on('connection', (c) => {
            conn = c;
            setupConnection();
        });

        peer.on('call', (call) => {
            if (confirm("Atender ligaÃ§Ã£o de voz?")) {
                navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                    call.answer(stream);
                    document.getElementById('call-overlay').style.display = 'flex';
                    call.on('stream', (remoteS) => {
                        document.getElementById('remoteAudio').srcObject = remoteS;
                    });
                });
            }
        });

        peer.on('error', () => {
            alert("Erro: Verifique se a sala jÃ¡ existe.");
            location.reload();
        });
    }

    function setupConnection() {
        conn.on('open', () => {
            conn.send({ type: 'intro', name: myName });
        });

        conn.on('data', (data) => {
            if (data.type === 'intro') {
                document.getElementById('peer-name').innerText = data.name;
                document.getElementById('avatar').innerText = data.name.charAt(0).toUpperCase();
            } else if (data.type === 'text') {
                appendMsg(data.name, data.msg, 'them');
            } else if (data.type === 'file') {
                appendFile(data.name, data.file, data.fileName, 'them');
            } else if (data.type === 'typing') {
                document.getElementById('typing-status').innerText = data.is ? 'Digitando...' : '';
            }
        });
    }

    function sendMessage() {
        const text = msgInput.value.trim();
        if (!text || !conn) return;
        conn.send({ type: 'text', name: myName, msg: text });
        appendMsg(myName, text, 'me');
        msgInput.value = '';
        sendTyping(false);
    }

    function appendMsg(user, msg, side) {
        const div = document.createElement('div');
        div.className = `msg ${side === 'me' ? 'msg-me' : 'msg-them'}`;
        div.innerText = msg;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function handleFile(input) {
        const file = input.files[0];
        if (!file || !conn) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            conn.send({ type: 'file', name: myName, file: e.target.result, fileName: file.name });
            appendFile(myName, e.target.result, file.name, 'me');
        };
        reader.readAsDataURL(file);
    }

    function appendFile(user, data, name, side) {
        const div = document.createElement('div');
        div.className = `msg ${side === 'me' ? 'msg-me' : 'msg-them'}`;
        if (data.startsWith('data:image')) {
            div.innerHTML = `<img src="${data}" class="rounded-lg max-w-full">`;
        } else {
            div.innerHTML = `<div class="flex items-center gap-2">ðŸ“„ <span class="text-xs">${name}</span></div>`;
        }
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function sendTyping(force = null) {
        if (conn) conn.send({ type: 'typing', is: force !== null ? force : msgInput.value.length > 0 });
    }

    function clearChat() {
        if (confirm("Limpar toda a conversa?")) messagesDiv.innerHTML = "";
    }

    function exitRoom() {
        if (confirm("Deseja sair da sala?")) location.reload();
    }

    async function startAudioCall() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            const call = peer.call(conn.peer, stream);
            document.getElementById('call-overlay').style.display = 'flex';
            call.on('stream', (remoteS) => {
                document.getElementById('remoteAudio').srcObject = remoteS;
            });
        } catch (e) { alert("Sem acesso ao microfone."); }
    }

    function endCall() { location.reload(); }

    msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
</script>
</body>
</html>            <div class="grid grid-cols-5 gap-3 justify-items-center">
                <button onclick="setTheme('#f97316')" class="w-9 h-9 rounded-xl bg-orange-500"></button>
                <button onclick="setTheme('#22c55e')" class="w-9 h-9 rounded-xl bg-green-500"></button>
                <button onclick="setTheme('#3b82f6')" class="w-9 h-9 rounded-xl bg-blue-500"></button>
                <button onclick="setTheme('#ef4444')" class="w-9 h-9 rounded-xl bg-red-500"></button>
                <button onclick="setTheme('#a855f7')" class="w-9 h-9 rounded-xl bg-purple-500"></button>
            </div>
            <button onclick="clearAllData()" class="w-full py-3 bg-red-900/10 text-red-500 border border-red-900/30 rounded-xl font-bold text-[9px] uppercase">Apagar Dados</button>
            <button onclick="closeSettings()" class="w-full py-3 bg-white/5 rounded-xl text-[9px] font-black uppercase">Voltar</button>
        </div>
    </div>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>
    <audio id="ring-sound" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop preload="auto"></audio>

    <script>
        let peer = null, connections = [], myNick = "", roomKey = "", currentCall = null, localStream = null;
        const $ = document.querySelector.bind(document);

        // --- SISTEMA DE CHAMADA ---

        async function startCall() {
            if (connections.length === 0) return alert("NinguÃ©m na sala para ligar!");
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const partnerId = connections[0].peer;
                currentCall = peer.call(partnerId, localStream);
                setupCallHandlers(currentCall);
                $('#active-call-ui').classList.remove('hidden');
                sysMsg("SISTEMA", "Chamando parceiro...");
            } catch (err) {
                alert("Erro ao acessar microfone. Verifique as permissÃµes HTTPS.");
            }
        }

        function setupCallHandlers(call) {
            call.on('stream', remoteStream => {
                const audio = new Audio();
                audio.srcObject = remoteStream;
                audio.play();
                $('#active-call-ui').classList.remove('hidden');
                $('#ring-sound').pause();
            });
            call.on('close', () => endCallUI());
        }

        function answerCall() {
            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                localStream = stream;
                currentCall.answer(localStream);
                setupCallHandlers(currentCall);
                $('#call-modal').classList.add('hidden');
                $('#ring-sound').pause();
            });
        }

        function rejectCall() {
            currentCall.close();
            $('#call-modal').classList.add('hidden');
            $('#ring-sound').pause();
        }

        function endCall() {
            if (currentCall) currentCall.close();
            endCallUI();
        }

        function endCallUI() {
            if (localStream) localStream.getTracks().forEach(t => t.stop());
            $('#active-call-ui').classList.add('hidden');
            $('#call-modal').classList.add('hidden');
            $('#ring-sound').pause();
            currentCall = null;
        }

        // --- LÃ“GICA DO CHAT ---

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            if(params.has('sala')) $('#room').value = params.get('sala');
            if(params.has('senha')) $('#pass').value = params.get('senha');
            $('#nick').value = localStorage.getItem('tp_nick') || '';
            $('#room').value = $('#room').value || localStorage.getItem('tp_room') || '';
            $('#pass').value = $('#pass').value || localStorage.getItem('tp_pass') || '';
            if(localStorage.getItem('tp_color')) setTheme(localStorage.getItem('tp_color'));
        };

        function start(isHost) {
            myNick = $('#nick').value.trim();
            const r = $('#room').value.trim().toLowerCase().replace(/\s+/g, '-');
            roomKey = $('#pass').value.trim();
            if(!myNick || !r || !roomKey) return;
            
            localStorage.setItem('tp_nick', myNick);
            localStorage.setItem('tp_room', r);
            localStorage.setItem('tp_pass', roomKey);

            peer = new Peer(isHost ? `room-${r}` : undefined, { debug: 1 });
            
            peer.on('open', () => {
                $('#lobby-ui').classList.add('hidden');
                $('#chat-ui').classList.replace('hidden', 'flex');
                if(!isHost) connectToPeer(`room-${r}`);
            });

            peer.on('connection', setupConn);

            // Handler para receber ligaÃ§Ã£o
            peer.on('call', call => {
                currentCall = call;
                $('#caller-name').innerText = $('#partner-name').innerText;
                $('#call-modal').classList.remove('hidden');
                $('#ring-sound').play();
            });
        }

        function connectToPeer(id) {
            setupConn(peer.connect(id, { reliable: true }));
        }

        function setupConn(c) {
            c.on('open', () => {
                c.send({type:'auth', pass: CryptoJS.AES.encrypt('valid', roomKey).toString(), nick: myNick});
                c.on('data', data => {
                    if(data.type === 'auth') {
                        $('#partner-name').innerText = data.nick;
                        updateStatusUI('online');
                        sysMsg("SISTEMA", `${data.nick} entrou.`);
                    }
                    if(data.type === 'msg') renderMsg(data.user, CryptoJS.AES.decrypt(data.txt, roomKey).toString(CryptoJS.enc.Utf8), 'other');
                    if(data.type === 'typing') toggleTypingUI(true, data.user);
                    if(data.type === 'status') updateStatusUI(data.val);
                });
                connections.push(c);
            });
        }

        function sendMsg() {
            const txt = $('#msg-input').value.trim();
            if(!txt || connections.length === 0) return;
            connections.forEach(c => c.send({type:'msg', user: myNick, txt: CryptoJS.AES.encrypt(txt, roomKey).toString()}));
            renderMsg(myNick, txt, 'self');
            $('#msg-input').value = "";
        }

        function renderMsg(user, content, side) {
            const div = document.createElement('div');
            div.className = `flex flex-col mb-3 msg-pop ${side === 'self' ? 'items-end' : 'items-start'}`;
            div.innerHTML = `<div class="p-3 rounded-2xl text-xs max-w-[85%] ${side === 'self' ? 'theme-bg text-white rounded-tr-none' : 'bg-white/10 text-gray-200 rounded-tl-none theme-border'}">${content}</div>`;
            $('#chat-messages').appendChild(div);
            $('#chat-messages').scrollTop = $('#chat-messages').scrollHeight;
        }

        function shareRoom() {
            const url = `${window.location.origin}${window.location.pathname}?sala=${$('#room').value}&senha=${$('#pass').value}`;
            navigator.clipboard.writeText(url);
            alert("Link de convite copiado!");
        }

        function updateStatusUI(s) {
            const b = $('#status-ball'), t = $('#conn-status');
            b.className = `w-2.5 h-2.5 rounded-full ${s === 'online' ? 'bg-green-500 shadow-[0_0_8px_#22c55e]' : 'bg-red-500 shadow-[0_0_8px_red]'}`;
            t.innerText = s === 'online' ? "Online" : "Offline";
        }

        function sysMsg(u, t) {
            const p = document.createElement('p');
            p.className = "text-center text-[8px] text-gray-500 uppercase my-2 font-bold";
            p.innerText = `// ${t} //`;
            $('#chat-messages').appendChild(p);
        }

        function toggleTypingUI(show, user) {
            $('#typing-ui').innerText = `${user} digitando...`;
            $('#typing-ui').style.display = show ? 'block' : 'none';
            if(show) setTimeout(() => $('#typing-ui').style.display = 'none', 3000);
        }

        function setTheme(c) {
            document.documentElement.style.setProperty('--main', c);
            document.documentElement.style.setProperty('--glow', c + '66');
            localStorage.setItem('tp_color', c);
        }

        function openSettings() { $('#modal').classList.remove('hidden'); }
        function closeSettings() { $('#modal').classList.add('hidden'); }
        function exitChat() { location.reload(); }
        function clearAllData() { localStorage.clear(); location.reload(); }
        function clearMessages() { $('#chat-messages').innerHTML = ""; }

        $('#msg-input').oninput = () => connections.forEach(c => c.send({type: 'typing', user: myNick}));
        $('#msg-input').onkeypress = (e) => e.key === 'Enter' && sendMsg();
    </script>
</body>
</html>


